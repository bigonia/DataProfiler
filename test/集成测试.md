### **外部API集成测试方案**

#### **1. 测试概述**

**1.1. 测试目的**

本测试方案旨在通过一个独立的外部测试脚本，对“智能数据剖析与处理平台”已部署的后端服务进行黑盒API集成测试。其主要目的包括：

  * **验证端到端流程**: 确保从数据源配置到报告查询再到资源清理的整个核心业务流程能够正确无误地执行。
  * **验证模块间集成**: 从API层面验证`DataSourceService`、`ProfilingService`等后端模块之间的交互和数据流转是否符合设计预期。
  * **保障接口稳定性**: 作为回归测试套件，在版本迭代后快速验证核心API的功能是否稳定、未被破坏。

**1.2. 测试方法**

采用**黑盒测试**方法，测试脚本作为API客户端，与运行中的应用实例进行HTTP交互。脚本不关心应用的内部实现，只关心API的请求与响应是否符合“契约”（OpenAPI规范）。

**1.3. 核心理念**

  * **配置与代码分离**: 测试脚本不硬编码任何环境信息或敏感数据，所有配置均由外部文件定义。
  * **默认完整性测试**: 脚本默认执行最重要、覆盖范围最广的“完整生命周期”测试。
  * **支持快速模块验证**: 提供命令行参数，允许开发者或测试人员针对特定模块（如数据源管理）进行快速、独立的测试。

#### **2. 环境与配置**

**2.1. 前置条件**

1.  **应用实例**: 一个正在运行的“智能数据剖析与处理平台”后端应用实例。
2.  **测试执行环境**: 安装了Python 3.x及`requests`库的机器。
3.  **测试数据**: 准备一个用于上传的`SalesData.xlsx`测试文件。

**2.2. 测试配置文件 (`test_config.json`)**

所有测试所需的环境变量和数据源信息都定义在此文件中，与测试脚本分离。

```json
{
  "api_base_url": "http://localhost:8080/api/v1",
  "sample_file_path": "./data/SalesData.xlsx",
  "test_data_sources": [
    {
      "config_name": "TestMySQL",
      "payload": {
        "name": "My Test MySQL DB",
        "type": "MYSQL",
        "properties": {
          "host": "mysql-test-host",
          "port": 3306,
          "username": "test_user",
          "password": "test_password",
          "database": "test_db"
        }
      }
    }
  ]
}
```

#### **3. 测试脚本设计**

**3.1. 脚本语言**

推荐使用 **Python** 及其 `requests` 库，因其简洁的语法和强大的HTTP处理能力。

**3.2. 执行方式**

脚本 (`test_runner.py`) 通过命令行执行：

1.  **执行默认的完整生命周期测试**:

    ```bash
    python test_runner.py
    ```

2.  **执行指定的模块测试**:

    ```bash
    # 仅测试数据源管理模块
    python test_runner.py --module datasource

    # 未来可以扩展其他模块，如 --module report_query
    ```

**3.3. 脚本结构**

脚本内部应包含：

  * **配置加载器**: 负责读取`test_config.json`。
  * **API客户端**: 封装了`GET`, `POST`, `DELETE`等HTTP方法，并处理了URL拼接、Header设置和基本的响应断言。
  * **测试用例函数**: 每个测试场景（如`test_full_lifecycle`, `test_datasource_module`）被封装在一个独立的函数中。
  * **主函数**: 解析命令行参数，并根据参数调用对应的测试用例函数。

#### **4. 核心测试用例**

**4.1. 默认测试：完整生命周期测试 (`python test_runner.py`)**

  * **目标**: 验证一个**文件数据源**从创建、剖析、查询到清理的完整流程。
  * **流程**:
    1.  **读取配置**: 脚本启动，加载 `test_config.json` 中的 `api_base_url` 和 `sample_file_path`。
    2.  **步骤1：创建文件数据源**:
          * **操作**: 调用 `POST /files/upload` 接口，上传配置文件中指定的Excel文件。
          * **验证**: 断言HTTP状态码为 `201`，并从响应中成功提取并存储 `dataSourceId`。
    3.  **步骤2：发起剖析任务**:
          * **操作**: 调用 `POST /profiling-tasks` 接口，请求体中包含上一步获取的`dataSourceId`。
          * **验证**: 断言HTTP状态码为 `202`，并成功提取并存储 `taskId`。
    4.  **步骤3：轮询任务状态**:
          * **操作**: 循环调用 `GET /task-status/{taskId}` 接口。
          * **验证**: 断言任务状态最终变为 `SUCCESS`。
    5.  **步骤4：查询摘要报告**:
          * **操作**: 调用 `POST /reports/summary` 接口，请求体中包含 `dataSourceId`。
          * **验证**: 断言HTTP状态码为 `200`，且返回的报告摘要内容与上传的Excel文件宏观信息（Sheet数量、名称等）一致。
    6.  **步骤5：查询详细报告**:
          * **操作**: 调用 `POST /reports/details` 接口，精确查询某个Sheet的详细数据。
          * **验证**: 断言HTTP状态码为 `200`，并对报告中的关键指标（如某列的`rowCount`, `nullCount`等）进行抽样断言，验证其准确性。
    7.  **步骤6：删除数据源**:
          * **操作**: 调用 `DELETE /data-sources/{dataSourceId}` 接口。
          * **验证**: 断言HTTP状态码为 `204` 或 `200`。
    8.  **步骤7：验证删除**:
          * **操作**: 再次调用 `GET /data-sources/{dataSourceId}` 接口。
          * **验证**: 断言HTTP状态码为 `404 Not Found`。

**4.2. 模块测试：数据源管理 (`python test_runner.py --module datasource`)**

  * **目标**: 快速验证数据源的增、删、改、查及连接测试功能，不涉及耗时的剖析任务。
  * **流程**:
    1.  **读取配置**: 脚本启动，加载 `test_config.json` 并获取 `test_data_sources` 列表中的第一个数据源配置（例如`TestMySQL`）。
    2.  **步骤1：创建数据源**:
          * **操作**: 调用 `POST /data-sources` 接口，请求体为`TestMySQL`的`payload`。
          * **验证**: 断言HTTP状态码为 `201`，并存储返回的 `dataSourceId`。
    3.  **步骤2：测试连接**:
          * **操作**: 调用 `POST /data-sources/{dataSourceId}/test-connection` 接口。
          * **验证**: 断言HTTP状态码为 `200`，且响应体中 `success` 字段为 `true`。
    4.  **步骤3：更新数据源**:
          * **操作**: 调用 `PUT /data-sources/{dataSourceId}` 接口，修改数据源的`name`字段。
          * **验证**: 断言HTTP状态码为 `200`。
    5.  **步骤4：查询并验证更新**:
          * **操作**: 调用 `GET /data-sources/{dataSourceId}` 接口。
          * **验证**: 断言HTTP状态码为 `200`，且返回的数据源`name`已更新。
    6.  **步骤5：删除数据源并验证**:
          * **操作**: 调用 `DELETE /data-sources/{dataSourceId}`，然后调用 `GET /data-sources/{dataSourceId}`。
          * **验证**: 第一个请求返回 `204` 或 `200`，第二个请求返回 `404`。

#### **5. 结果与报告**

测试脚本在执行过程中，应在控制台清晰地打印每一步的操作和结果，例如：

```
[INFO] Running test suite: Full Lifecycle Test
[PASS] Step 1: Create File Data Source (ID: ds-file-abcde123)
[PASS] Step 2: Initiate Profiling Task (ID: task-uuid-fghij456)
[INFO] Polling task status...
[PASS] Step 3: Task completed successfully.
[PASS] Step 4: Summary report validated.
[PASS] Step 5: Detailed report validated.
[PASS] Step 6: Data source deleted.
[PASS] Step 7: Deletion verified.
----------------------------------------
SUMMARY:
Tests Run: 7, Passed: 7, Failed: 0
```

这样的输出格式清晰明了，易于集成到CI/CD流程中。