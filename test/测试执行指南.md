# 测试执行指南

本文档提供了智能数据剖析与处理平台集成测试的详细执行指南。

## 快速开始

### 1. 环境准备

确保满足以下前置条件：

- **Python 3.x** 已安装
- **后端服务** 正在运行（默认端口：8080）
- **测试数据文件** 存在（sample_data.csv）

### 2. 安装依赖

```bash
cd test
pip install -r requirements.txt
```

### 3. 验证配置

检查 `test_config.json` 配置文件：

```json
{
  "api_base_url": "http://localhost:8080",
  "sample_file_path": "sample_data.csv",
  "test_data_sources": [...]
}
```

## 测试执行方式

### 方式一：Python脚本（推荐）

```bash
# 执行所有测试模块
python test_runner.py --module all

# 执行单个模块测试
python test_runner.py --module datasource
python test_runner.py --module profiling
python test_runner.py --module report
python test_runner.py --module file
```

### 方式二：Windows批处理脚本

```cmd
# 执行所有测试
run_tests.bat

# 执行指定模块
run_tests.bat datasource
run_tests.bat profiling
```

## 测试模块说明

### 1. 数据源模块测试 (datasource)

**测试内容：**
- 创建数据源配置
- 测试数据源连接
- 获取数据源信息
- 更新数据源配置
- 删除数据源
- 验证删除结果

**API覆盖：**
- `POST /datasources` - 创建数据源
- `GET /datasources/{sourceId}` - 获取数据源
- `PUT /datasources/{sourceId}` - 更新数据源
- `DELETE /datasources/{sourceId}` - 删除数据源
- `POST /datasources/{sourceId}/test` - 测试连接

### 2. 任务执行模块测试 (profiling)

**测试内容：**
- 创建数据源
- 启动剖析任务
- 监控任务状态
- 等待任务完成
- 删除剖析任务
- 清理数据源

**API覆盖：**
- `POST /profiling/profiling-tasks` - 启动任务
- `GET /profiling/task-status/{taskId}` - 查询状态
- `DELETE /profiling/profiling-tasks/{taskId}` - 删除任务

### 3. 报告查询模块测试 (report)

**测试内容：**
- 创建数据源并执行剖析
- 查询摘要报告
- 查询详细报告
- 验证报告内容
- 清理测试数据

**API覆盖：**
- `GET /api/reports/{taskId}/summary` - 摘要报告
- `POST /api/reports/{taskId}/detailed` - 详细报告

### 4. 文件上传生命周期测试 (file)

**测试内容：**
- 上传文件并创建数据源
- 启动剖析任务
- 监控任务执行
- 查询生成的报告
- 完整清理流程

**API覆盖：**
- `POST /files/upload` - 文件上传
- 完整的任务和报告流程

## 测试结果解读

### 成功输出示例

```
[INFO] Running Data Source Module Test
==================================================
[PASS] Step 1: Create Data Source (Status: 201)
[PASS] Step 2: Test Connection (Status: 200)
[PASS] Step 3: Get Data Source (Status: 200)
[PASS] Step 4: Update Data Source (Status: 200)
[PASS] Step 5: Verify Update (Status: 200)
[PASS] Step 5: Name update verified
[PASS] Step 6: Delete Data Source (Status: 204)
[PASS] Step 7: Verify Deletion (Status: 404)

==================================================
SUMMARY:
Tests Run: 8, Passed: 8, Failed: 0
[SUCCESS] All tests passed!
```

### 失败输出示例

```
[INFO] Running Data Source Module Test
==================================================
[PASS] Step 1: Create Data Source (Status: 201)
[FAIL] Step 2: Test Connection - Expected 200, got 500
    Response: {"error": "Database connection failed"}
[PASS] Step 3: Get Data Source (Status: 200)
...

==================================================
SUMMARY:
Tests Run: 8, Passed: 6, Failed: 2
[FAILURE] 2 test(s) failed
```

## 故障排除

### 常见问题

1. **连接错误 (Connection refused)**
   - 检查后端服务是否启动
   - 验证端口配置是否正确
   - 确认防火墙设置

2. **文件不存在错误**
   - 检查 `sample_data.csv` 文件是否存在
   - 验证配置文件中的路径设置

3. **数据库连接失败**
   - 检查数据库服务是否运行
   - 验证连接参数（主机、端口、用户名、密码）
   - 确认数据库权限设置

4. **任务超时**
   - 检查数据源数据量大小
   - 调整任务轮询超时时间
   - 查看后端日志获取详细信息

### 调试技巧

1. **启用详细日志**
   ```python
   # 在测试脚本中添加调试信息
   import logging
   logging.basicConfig(level=logging.DEBUG)
   ```

2. **单步执行测试**
   - 使用单个模块测试定位问题
   - 检查每个API响应的详细内容

3. **检查后端日志**
   - 查看应用日志文件
   - 关注错误和异常信息

## 持续集成

### Jenkins集成示例

```groovy
pipeline {
    agent any
    stages {
        stage('Setup') {
            steps {
                sh 'pip install -r test/requirements.txt'
            }
        }
        stage('Integration Tests') {
            steps {
                sh 'cd test && python test_runner.py --module all'
            }
        }
    }
    post {
        always {
            publishTestResults testResultsPattern: 'test/results.xml'
        }
    }
}
```

### GitHub Actions集成示例

```yaml
name: Integration Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'
    - name: Install dependencies
      run: |
        pip install -r test/requirements.txt
    - name: Run integration tests
      run: |
        cd test
        python test_runner.py --module all
```

## 最佳实践

1. **定期执行测试**
   - 在代码提交前运行相关模块测试
   - 在部署前执行完整测试套件

2. **环境隔离**
   - 使用独立的测试数据库
   - 避免测试数据污染生产环境

3. **测试数据管理**
   - 使用可重复的测试数据
   - 确保测试后完整清理

4. **监控和报告**
   - 记录测试执行时间
   - 跟踪测试成功率趋势
   - 及时处理失败的测试用例