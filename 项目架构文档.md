# DBCrawlerV3 项目架构文档

## 项目概述

DBCrawlerV3 是一个数据库分析和剖析系统，用于连接多种数据库，执行数据剖析任务，并生成结构化报告。系统采用Spring Boot框架构建，遵循分层架构设计原则。

## 技术栈

- **框架**: Spring Boot 2.7.14
- **数据访问**: Spring Data JPA
- **数据库**: 支持多种数据库类型（MySQL、PostgreSQL、Oracle、SQL Server等）
- **构建工具**: Maven
- **Java版本**: Java 8+

## 系统架构

### 分层架构

```
┌─────────────────────────────────────┐
│           Controller Layer          │  # REST API控制器层
├─────────────────────────────────────┤
│            Service Layer            │  # 业务逻辑服务层
├─────────────────────────────────────┤
│          Repository Layer           │  # 数据访问层
├─────────────────────────────────────┤
│            Entity Layer             │  # 实体模型层
└─────────────────────────────────────┘
```

### 核心模块

1. **数据源管理模块** (DataSource)
2. **剖析任务模块** (ProfilingTask)
3. **结构化报告模块** (StructuredReport)

## 数据模型设计

### 1. DataSource (数据源实体)

**职责**: 管理数据库连接配置和连接状态

**主要字段**:
- `id`: 主键ID
- `name`: 数据源名称
- `databaseType`: 数据库类型枚举
- `host`: 数据库主机地址
- `port`: 数据库端口
- `databaseName`: 数据库名称
- `username`: 用户名
- `password`: 密码
- `status`: 连接状态枚举
- `isActive`: 是否激活
- `lastTestedAt`: 最后测试时间
- `errorMessage`: 错误信息
- `profilingTasks`: 关联的剖析任务列表

**枚举类型**:
- `DatabaseType`: MYSQL, POSTGRESQL, ORACLE, SQL_SERVER, SQLITE
- `ConnectionStatus`: ACTIVE, INACTIVE, ERROR, TESTING

**核心方法**:
- `buildConnectionUrl()`: 构建数据库连接URL
- `testConnection()`: 测试数据库连接
- `getDriverClassName()`: 获取驱动类名

### 2. ProfilingTask (剖析任务实体)

**职责**: 管理数据剖析任务的执行和状态跟踪

**主要字段**:
- `id`: 主键ID
- `taskId`: 任务唯一标识符
- `name`: 任务名称
- `description`: 任务描述
- `dataSource`: 关联的数据源
- `taskType`: 任务类型枚举
- `status`: 任务状态枚举
- `targetSchema`: 目标模式
- `targetTable`: 目标表
- `progress`: 执行进度(0-100)
- `startedAt`: 开始时间
- `completedAt`: 完成时间
- `retryCount`: 重试次数
- `errorMessage`: 错误信息
- `statusMessage`: 状态消息
- `generationTimeMs`: 生成耗时(毫秒)
- `structuredReports`: 关联的结构化报告列表

**枚举类型**:
- `TaskType`: FULL_SCAN, SCHEMA_SCAN, TABLE_SCAN, COLUMN_SCAN
- `TaskStatus`: PENDING, RUNNING, COMPLETED, FAILED, CANCELLED

**核心方法**:
- `canStart()`: 检查是否可以启动
- `canCancel()`: 检查是否可以取消
- `canRetry()`: 检查是否可以重试
- `calculateProgress()`: 计算执行进度

### 3. StructuredReport (结构化报告实体)

**职责**: 存储和管理数据剖析结果报告

**主要字段**:
- `id`: 主键ID
- `name`: 报告名称
- `description`: 报告描述
- `profilingTask`: 关联的剖析任务
- `type`: 报告类型枚举
- `format`: 报告格式枚举
- `status`: 报告状态枚举
- `targetSchema`: 目标模式
- `targetTable`: 目标表
- `filePath`: 文件路径
- `fileSize`: 文件大小
- `compressedSize`: 压缩后大小
- `isCompressed`: 是否压缩
- `checksum`: 文件校验和
- `content`: 报告内容
- `summary`: 报告摘要
- `metadata`: 元数据
- `generationTimeMs`: 生成耗时
- `tableCount`: 表数量
- `columnCount`: 列数量
- `rowCount`: 行数量
- `errorMessage`: 错误信息
- `expiresAt`: 过期时间
- `lastAccessedAt`: 最后访问时间
- `accessCount`: 访问次数
- `isCached`: 是否缓存
- `cacheKey`: 缓存键

**枚举类型**:
- `ReportType`: SUMMARY, DETAILED, FULL, CUSTOM
- `ReportFormat`: JSON, XML, CSV, HTML, PDF
- `ReportStatus`: GENERATING, COMPLETED, FAILED, EXPIRED

**核心方法**:
- `isExpired()`: 检查是否过期
- `getCompressionRatio()`: 获取压缩比
- `getFormattedFileSize()`: 获取格式化文件大小
- `recordAccess()`: 记录访问
- `generateCacheKey()`: 生成缓存键

## 数据访问层 (Repository)

### DataSourceRepository

**职责**: 数据源的数据访问操作

**核心查询方法**:
- `findByName(String name)`: 按名称查找
- `findByIsActiveTrue()`: 查找活跃数据源
- `findByDatabaseType(DatabaseType type)`: 按数据库类型查找
- `findByStatus(ConnectionStatus status)`: 按连接状态查找
- `findDataSourcesNeedingTest(LocalDateTime cutoffTime)`: 查找需要测试的数据源
- `findByHostAndPort(String host, Integer port)`: 按主机和端口查找
- `existsByNameIgnoreCase(String name)`: 检查名称是否存在
- `findByCreatedAtBetween(LocalDateTime start, LocalDateTime end)`: 按创建时间范围查找
- `findDataSourcesWithProfilingTasks()`: 查找有关联任务的数据源
- `updateConnectionStatus(Long id, ConnectionStatus status, LocalDateTime testedAt, String errorMessage)`: 更新连接状态

### ProfilingTaskRepository

**职责**: 剖析任务的数据访问操作

**核心查询方法**:
- `findByTaskId(String taskId)`: 按任务ID查找
- `findByStatus(TaskStatus status, Pageable pageable)`: 按状态查找(分页)
- `findByDataSourceId(Long dataSourceId)`: 按数据源ID查找
- `findByTaskType(TaskType taskType)`: 按任务类型查找
- `findByTargetSchema(String targetSchema)`: 按目标模式查找
- `findByTargetTable(String targetTable)`: 按目标表查找
- `findByTargetSchemaAndTargetTable(String schema, String table)`: 按模式和表查找
- `findRunningTasks()`: 查找运行中任务
- `findByCreatedAtBetween(LocalDateTime start, LocalDateTime end)`: 按创建时间范围查找
- `findTimeoutTasks(LocalDateTime cutoffTime)`: 查找超时任务
- `findLatestTaskByDataSource(Long dataSourceId)`: 查找数据源最新任务
- `findSuccessfulTasksByDataSource(Long dataSourceId)`: 查找数据源成功任务
- `countByStatus(TaskStatus status)`: 按状态统计
- `countByDataSourceAndStatus(Long dataSourceId, TaskStatus status)`: 按数据源和状态统计
- `countByStatusGrouped()`: 按状态分组统计
- `findRetryableTasks(int maxRetries)`: 查找可重试任务
- `findByProgressBetween(int min, int max)`: 按进度范围查找
- `findByNameContainingIgnoreCase(String pattern)`: 按名称模式查找
- `findTasksWithReports()`: 查找有报告的任务
- `updateTaskProgress(Long id, int progress)`: 更新任务进度
- `updateTaskStatus(Long id, TaskStatus status, LocalDateTime completedAt)`: 更新任务状态
- `deleteOldCompletedTasks(LocalDateTime cutoffDate)`: 删除旧的已完成任务

### StructuredReportRepository

**职责**: 结构化报告的数据访问操作

**核心查询方法**:
- `findByProfilingTaskId(Long profilingTaskId)`: 按剖析任务ID查找
- `findByTaskId(String taskId)`: 按任务ID字符串查找
- `findByType(ReportType type)`: 按报告类型查找
- `findByStatus(ReportStatus status, Pageable pageable)`: 按状态查找(分页)
- `findByFormat(ReportFormat format)`: 按格式查找
- `findByTargetSchema(String targetSchema)`: 按目标模式查找
- `findByTargetTable(String targetTable)`: 按目标表查找
- `findByTargetSchemaAndTargetTable(String schema, String table)`: 按模式和表查找
- `findByCreatedAtBetween(LocalDateTime start, LocalDateTime end)`: 按创建时间范围查找
- `findExpiredReports(LocalDateTime now)`: 查找过期报告
- `findCachedReports()`: 查找缓存报告
- `findByCacheKey(String cacheKey)`: 按缓存键查找
- `findByFileSizeBetween(Long minSize, Long maxSize)`: 按文件大小范围查找
- `findCompressedReports()`: 查找压缩报告
- `findLongGenerationTimeReports(Long thresholdMs)`: 查找生成时间长的报告
- `findByNameContainingIgnoreCase(String pattern)`: 按名称模式查找
- `findHighAccessReports(Integer minAccessCount)`: 查找高访问报告
- `findStaleReports(LocalDateTime cutoffTime)`: 查找陈旧报告
- `countByStatus(ReportStatus status)`: 按状态统计
- `countByType(ReportType type)`: 按类型统计
- `countByStatusGrouped()`: 按状态分组统计
- `countByTypeGrouped()`: 按类型分组统计
- `getTotalFileSize()`: 获取总文件大小
- `getTotalCompressedSize()`: 获取总压缩大小
- `updateAccessInfo(Long id, LocalDateTime accessedAt)`: 更新访问信息
- `updateReportStatus(Long id, ReportStatus status)`: 更新报告状态
- `deleteExpiredReports(LocalDateTime now)`: 删除过期报告
- `findByCreatedAtBefore(LocalDateTime cutoffDate)`: 查找指定时间前创建的报告

## 业务逻辑层 (Service)

### DataSourceService 接口

**职责**: 数据源管理的业务逻辑

**核心功能**:
- 数据源的CRUD操作
- 数据库连接测试和状态管理
- 数据源配置验证
- 连接URL构建和驱动管理
- 数据源激活/禁用
- 统计和查询功能

**实现类**: `DataSourceServiceImpl`

### ProfilingTaskService 接口

**职责**: 剖析任务管理的业务逻辑

**核心功能**:
- 任务的创建、更新、删除
- 任务状态管理和进度跟踪
- 任务执行控制(启动、完成、取消、重试)
- 任务查询和统计
- 任务验证和生命周期管理
- 超时任务处理和清理

**实现类**: `ProfilingTaskServiceImpl`

### StructuredReportService 接口

**职责**: 结构化报告管理的业务逻辑

**核心功能**:
- 报告的创建、更新、删除
- 报告内容压缩和解压缩
- 报告导入导出
- 报告访问记录和缓存管理
- 报告生命周期管理(过期、清理)
- 报告统计和分析
- 报告摘要生成和元数据刷新

**实现类**: `StructuredReportServiceImpl`

## 关键设计模式

### 1. 分层架构模式
- **Controller**: 处理HTTP请求和响应
- **Service**: 实现业务逻辑
- **Repository**: 数据访问抽象
- **Entity**: 领域模型

### 2. 依赖注入模式
- 使用Spring的`@Autowired`注解进行依赖注入
- 接口与实现分离，提高可测试性

### 3. 仓储模式 (Repository Pattern)
- 继承`JpaRepository`提供基础CRUD操作
- 自定义查询方法满足业务需求
- 使用`@Query`注解定义复杂查询

### 4. 服务层模式 (Service Layer Pattern)
- 封装业务逻辑
- 事务管理
- 数据验证和转换

## 数据库设计原则

### 1. 实体关系
- **DataSource** 1:N **ProfilingTask**: 一个数据源可以有多个剖析任务
- **ProfilingTask** 1:N **StructuredReport**: 一个任务可以生成多个报告

### 2. 索引策略
- 主键自动索引
- 外键字段建立索引
- 常用查询字段建立复合索引
- 时间字段建立索引支持范围查询

### 3. 数据完整性
- 外键约束保证引用完整性
- 非空约束保证必要字段
- 枚举类型约束保证数据有效性
- 检查约束保证数据范围有效性

## 配置和部署

### 应用配置
- 数据库连接配置
- JPA配置
- 日志配置
- 缓存配置

### 部署要求
- Java 8+ 运行环境
- 支持的数据库服务器
- 足够的存储空间用于报告文件
- 网络连接用于数据库访问

## 扩展性设计

### 1. 数据库类型扩展
- 新增数据库类型只需扩展`DatabaseType`枚举
- 添加对应的驱动类名和URL构建逻辑

### 2. 报告格式扩展
- 新增报告格式只需扩展`ReportFormat`枚举
- 实现对应的导入导出逻辑

### 3. 任务类型扩展
- 新增任务类型只需扩展`TaskType`枚举
- 实现对应的执行逻辑

## 性能优化

### 1. 数据库优化
- 合理使用索引
- 分页查询避免大结果集
- 连接池配置优化

### 2. 缓存策略
- 报告缓存机制
- 查询结果缓存
- 连接状态缓存

### 3. 异步处理
- 长时间运行的任务异步执行
- 报告生成异步处理
- 批量操作优化

## 安全考虑

### 1. 数据安全
- 数据库密码加密存储
- 敏感信息脱敏
- 访问日志记录

### 2. 连接安全
- SSL连接支持
- 连接超时设置
- 错误信息过滤

### 3. 文件安全
- 报告文件访问控制
- 文件路径验证
- 临时文件清理

## 监控和维护

### 1. 日志记录
- 操作日志
- 错误日志
- 性能日志

### 2. 健康检查
- 数据库连接状态
- 任务执行状态
- 系统资源使用

### 3. 定期维护
- 过期报告清理
- 日志文件轮转
- 数据库维护

## 总结

DBCrawlerV3采用了清晰的分层架构和模块化设计，通过合理的实体关系设计和完善的业务逻辑封装，提供了一个可扩展、可维护的数据库分析和剖析系统。系统支持多种数据库类型，提供了完整的任务管理和报告生成功能，同时考虑了性能、安全和可维护性等方面的需求。