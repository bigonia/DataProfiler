### **智能数据剖析与处理平台 - 概要设计文档 v1.0**

#### 1\. 项目整体描述

本平台通过一套分层、策略驱动的架构，为企业提供高效、安全的数据剖析能力。其核心工作方式是：首先，通过统一的数据源管理模块，接入支持**数据库级**或**特定Schema（模式）级**的异构数据系统，或通过**兼容层**处理**Excel等文件类数据**；其次，核心剖析引擎采用**内置的自适应策略**，根据表的数据规模自动选择最优执行路径（精确查询或近似分析），高效抓取原始数据；最后，独立的报告组装服务将原始数据加工成标准化的结构性报告。平台本身基于**SQLite**实现轻量级持久化，管理所有配置、任务与报告数据，并通过分层的API接口对外提供服务。

#### 2\. 项目目标

  * **统一的数据接入**: 无缝处理包括关系型数据库和Excel文件在内的多种数据源。
  * **卓越的性能与安全**: 内置的自适应策略与优化的SQL执行，自动平衡分析精度与系统开销。
  * **轻量级与可移植**: 以SQLite为核心持久化单元，简化部署和数据管理。
  * **灵活的剖析范围**: 支持在数据源配置或执行任务时灵活定义Schema与表的范围。
  * **高效的数据表示**: 为API提供可选的载荷结构压缩（如`header-rows`格式），以最小化报文体积。
  * **开放的AI接口**: 提供分层的查询API（摘要与详细），为下游系统提供灵活的数据消费方式。

#### 3\. 系统功能模块划分

| 模块名称 | 核心职责 | 前端对应组件 | 后端对应服务 |
| :--- | :--- | :--- | :--- |
| **数据源管理** | 统一管理多类型数据源的连接配置，支持定义Schema范围。 | `DataSourceManager` | `DataSourceService` |
| **高效数据剖析引擎**| **(核心)** 接收并编排单源及多源剖析任务，采用自适应策略执行分析。 | `ProfilingTaskCreator` | `ProfilingService` |
| **结构化报告系统**| 接收原始剖析数据，执行转换、计算和持久化，并提供分层的报告查询API。 | `StructuredReportViewer`| `ReportAssemblyService`, `StructuredReportService`|
| **AI分析引擎对接** | **(暂不实现)** 对接外部AI分析接口如dify，将报告发送给大模型进行分析，并且得到分析报告，流式返回，这部分可以暂不实现，基于具体的AI报告接口对接即可。 | `AIAnalysisView` | `AIIntegrationService` |
| **文件即服务** | **(核心兼容层)** 将上传的Excel文件数据加载并持久化到平台核心的SQLite数据库中，使其能被标准的JDBC剖析流程处理。 | `FileUpload` | `FileAsTableService` |

#### 4\. 核心设计

**4.1. Schema (模式) 管理与剖析范围**
平台支持**数据库级**和**模式级**两种数据源连接方式，允许用户在配置或执行任务时灵活定义数据剖析的范围。

**4.2. 自适应剖析策略 (Adaptive Profiling Strategy)**
平台内置一套智能的自适应策略，对用户透明。系统会通过低成本的**预检**获取表的估算行数，并与一个**内部的、默认的决策阈值**进行比较，自动选择“精确执行路径”或“近似执行路径”。

**4.3. 文件类数据的兼容层设计 (File-to-SQLite)**
为了将Excel等文件数据无缝地融入到基于SQL的分析流程中，平台设计了一个与核心持久化方案紧密集成的兼容层：

1.  **上传与接收**: 用户通过`FileUpload`组件上传Excel文件，后端`FileAsTableService`接收文件。
2.  **融入核心数据存储**: 本平台使用一个核心的**SQLite数据库**来持久化所有应用数据（包括配置、任务与报告）。`FileAsTableService`会直接在这个核心SQLite数据库中，为上传的Excel文件创建对应的表。
3.  **数据映射与加载**:
      * 服务使用标准库（如Apache POI）解析Excel文件。
      * 遍历Excel中的**每一个Sheet（工作表）**。
      * 将每一个**Sheet的名称**作为SQLite中的一个**表名**。为避免不同文件间的命名冲突，表名可采用`[文件ID]_[Sheet名]`的格式。
      * 读取Sheet的第一行作为表的列定义，并创建表。
      * 将该Sheet下的所有数据行批量插入到新创建的SQLite表中。
4.  **统一分析**: 数据加载完成后，这些新创建的表就像系统中的任何其他表一样。`ProfilingService`会调用其内置的`SqliteProfiler`，对这些由Excel文件转换而来的表进行标准化的数据剖析。

**4.4. 分层剖析架构与核心服务**
平台采用分层解耦的设计，核心服务包括`ProfilingService`, `ReportAssemblyService`, `FusionAnalysisService`等，各服务职责明确，协同工作。

#### 5\. 数据报告服务与API

**5.1. 分层查询接口**

1.  **摘要查询接口 (`POST /reports/summary`)**: 提供对一个或多个数据源的**高度概括性预览**。
2.  **详细查询接口 (`POST /reports/details`)**: 提供一个或多个数据源下，指定表的**完整、细粒度**的剖析数据，并支持**载荷结构压缩**。

**5.2. 载荷结构压缩 (Payload Structural Compression)**
为适应AI应用上下文，详细查询接口支持通过`?format=compact`参数，将JSON从标准的键值对数组格式，切换为更紧凑的`header-rows`二维数组样式。

#### 6\. 基本数据结构定义

**6.1. `DataSourceConfig` (数据源配置)**
为`FILE`类型的数据源提供一个示例。对外而言，它仍然是一个“文件”类型的数据源。

```json
{
  "id": "ds-file-01",
  "name": "季度销售报告.xlsx",
  "type": "FILE",
  "properties": {
    "originalFileName": "季度销售报告.xlsx",
    "internalFileId": "file-xyz-789",
    "fileSize": 5120,
    "mimeType": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  }
}
```
其他DB类型的数据源定义：

```json
{
  "id": "ds-pg-01",
  "name": "数据仓库PG库",
  "type": "POSTGRESQL",
  "properties": {
    "host": "pg.dataprofiler.com",
    "port": 5432,
    "username": "user",
    "database": "sales_dw",
    "schema": "public"
  }
}
```

**6.2. `ReportSummaryDto` (分析报告摘要)**
摘要查询接口的返回对象。

```json
[ 
  {
    "dataSourceId": "ds-pg-01",
    "dataSourceName": "数据仓库PG库",
    "dataSourceType": "POSTGRESQL",
    "schemas": [
      {
        "schemaName": "public",
        "tables": [
          {
            "tableName": "orders",
            "rowCount": 1500000,
            "columnCount": 15,
            "comment": "销售订单表"
          }
        ]
      }
    ]
  }
]
```

**6.3. `DetailedReportRequest` (详细报告查询请求)**
详细查询接口的请求体。

```json
{
  "datasources": {
    "ds-pg-01": {
      "schemas": {
        "public": ["orders", "customers"]
      }
    },
    "ds-mysql-01": {
      "schemas": {
        "user_db": ["users"]
      }
    }
  },
  "pagination": { "page": 1, "pageSize": 10 }
}
```

**6.4. `StructuredReportDto` (标准化结构报告)**
详细查询接口返回的核心对象。包含`dataSourceType`信息。

```json
{
  "dataSourceId": "ds-pg-01",
  "dataSourceType": "POSTGRESQL",
  "database": { "name": "sales_dw" },
  "tables": [
    {
      "name": "orders",
      "schemaName": "public",
      "rowCount": 1500000,
      "columns": [ ],
      "sampleRows": {  }
    }
  ]
}
```

*注：`columns`和`sampleRows`的内部结构会根据`?format`参数在标准格式和紧凑格式之间切换。*

#### 7\. 建议在开发前明确的文档定义

  * **API设计文档 (基于OpenAPI/Swagger)**: 详细定义统一的分析任务创建接口、分层的报告查询API（摘要/详细），以及载荷压缩的`format`参数。
  * **数据契约 (Data Contract) 详细定义**: 对`ReportSummaryDto`、`DetailedReportRequest`以及`StructuredReportDto`的两种`format`模式进行详尽描述。
  * **数据库方言实现指南 (Database Dialect Implementation Guide)**: 规范化新增数据库`Profiler`的开发流程。
  * **测试策略文档 (Testing Strategy Document)**: 规划单元、集成和性能测试的范围与方法。