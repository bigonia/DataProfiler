### **详细设计文档 - 数据源服务 (DataSourceService)**

#### **1. 模块概述**

**1.1. 核心职责**

`DataSourceService`是平台的数据源管理核心。它全权负责`DataSourceConfig`实体的生命周期管理，包括：

  * **创建 (Create)**: 持久化新的数据源连接配置。
  * **读取 (Read)**: 提供查询单个或所有数据源配置的功能。
  * **更新 (Update)**: 修改已存在的数据源配置。
  * **删除 (Delete)**: 移除不再需要的数据源配置。
  * **连接测试 (Test Connection)**: 验证指定的数据源配置是否能够成功连接到目标数据库。

该服务是所有后续数据剖析任务的基础，为`ProfilingService`提供了获取目标数据库连接信息的统一入口。

**1.2. 核心实体与API**

  * **核心实体**: `com.dataprofiler.entity.DataSourceConfig`
  * **服务接口**: `com.dataprofiler.service.DataSourceService`
  * **API入口**: `com.dataprofiler.controller.DataSourceController`

#### **2. 接口定义 (Java Interface)**

定义清晰的服务接口是实现模块间解耦的关键。

```java
package com.dataprofiler.service;

import com.dataprofiler.dto.ConnectionTestResult;
import com.dataprofiler.entity.DataSourceConfig;

import java.util.List;
import java.util.Optional;

public interface DataSourceService {

    /**
     * 创建并持久化一个新的数据源配置。
     * @param config 待创建的数据源配置对象。
     * @return 持久化后的数据源配置，包含生成的ID。
     */
    DataSourceConfig createDataSource(DataSourceConfig config);

    /**
     * 根据ID查找一个数据源配置。
     * @param id 数据源的唯一ID。
     * @return 包含数据源配置的Optional，如果未找到则为空。
     */
    Optional<DataSourceConfig> getDataSourceById(String id);

    /**
     * 获取系统中所有的数据源配置列表。
     * @return 数据源配置的列表。
     */
    List<DataSourceConfig> getAllDataSources();

    /**
     * 更新一个已存在的数据源配置。
     * @param id 待更新数据源的ID。
     * @param config 更新后的数据源配置信息。
     * @return 更新后的数据源配置对象。
     */
    DataSourceConfig updateDataSource(String id, DataSourceConfig config);

    /**
     * 根据ID删除一个数据源配置。
     * @param id 待删除数据源的ID。
     */
    void deleteDataSource(String id);

    /**
     * 测试指定数据源配置的连通性。
     * @param id 待测试数据源的ID。
     * @return 连接测试的结果，包含成功状态、消息和耗时。
     */
    ConnectionTestResult testConnection(String id);
}
```

#### **3. 核心流程与实现逻辑**

**3.1. CRUD 操作逻辑**

CRUD操作的实现将主要委托给Spring Data JPA的`DataSourceConfigRepository`。

  * **`createDataSource` / `updateDataSource`**:

    1.  接收`DataSourceConfig`对象。
    2.  在保存到数据库前，可能需要对`properties`字段（一个`Map<String, Object>`）进行序列化。推荐使用JPA的`@Converter`注解，将其自动转换为JSON字符串后存入SQLite的TEXT字段中。
    3.  调用`repository.save(config)`方法进行持久化。

  * **`getDataSourceById` / `getAllDataSources` / `deleteDataSource`**:

    1.  直接调用`repository`对应的`findById`, `findAll`, `deleteById`方法。
    2.  对于`get`操作，从数据库取出的JSON字符串需要通过`@Converter`反序列化回`Map`对象。

**3.2. 连接测试 (`testConnection`) 核心逻辑**

这是该服务中最复杂的业务逻辑，需要动态处理不同类型的数据库连接。

1.  **获取配置**: `testConnection(id)`方法首先调用`getDataSourceById(id)`获取`DataSourceConfig`对象。如果不存在，则抛出资源未找到的异常。

2.  **动态驱动加载与URL构建**:

      * 根据`config.getType()`（如`MYSQL`, `POSTGRESQL`等），从一个工厂类或`Map`中获取对应的JDBC `driverClassName`和URL模板。
      * 例如，对于`MYSQL`，URL模板为 `jdbc:mysql://{host}:{port}/{database}`。
      * 使用`config.getProperties()`中的`host`, `port`, `database`等值，动态填充URL模板，构建最终的JDBC URL。

3.  **建立连接**:

      * 使用`java.sql.DriverManager.getConnection(url, username, password)`尝试建立连接。
      * **必须设置一个较短的连接超时**（如5秒），以避免在目标主机不通时，线程被长时间阻塞。这可以通过`DriverManager.setLoginTimeout()`或数据库驱动特定的属性来实现。

4.  **执行验证查询**:

      * 连接成功后，为了确保连接是真实可用的，需要执行一个简单、快速、无副作用的“心跳”查询。
      * **MySQL/PostgreSQL**: `SELECT 1`
      * **SQL Server**: `SELECT 1`
      * **SQLite**: `PRAGMA quick_check`
      * 执行查询并立即关闭`Statement`和`ResultSet`。

5.  **资源释放与结果返回**:

      * 使用`try-with-resources`语句或在`finally`块中，确保`Connection`对象一定被关闭，防止连接泄露。
      * **如果所有步骤成功**: 返回 `new ConnectionTestResult(true, "Connection successful!", duration)`。
      * **如果任何步骤失败**: 捕获`SQLException`或其他异常，将异常信息（如“用户名或密码错误”、“无法连接到主机”）作为`message`，返回`new ConnectionTestResult(false, e.getMessage(), duration)`。

#### **4. 数据结构定义 (DTOs & Entities)**

  * **`DataSourceConfig` (JPA Entity)**

      * 该实体类映射到SQLite的`data_sources`表。
      * 其`properties`字段（`Map<String, Object>`）将通过自定义的JPA `AttributeConverter`转换为JSON字符串进行存储。

  * **`ConnectionTestResult` (DTO)**

      * 这是一个简单的数据传输对象，用于封装连接测试的返回结果。
      * **结构定义**:
        ```java
        public class ConnectionTestResult {
            private boolean success;
            private String message;
            private long durationMs; // 连接测试耗时(毫秒)

            // Constructors, Getters, Setters
        }
        ```

#### **5. API 端点**

由`DataSourceController`暴露以下RESTful API：

| Method | Path | 调用服务方法 | 描述 |
| :--- | :--- | :--- | :--- |
| `POST` | `/data-sources` | `createDataSource` | 创建新的数据源 |
| `GET` | `/data-sources` | `getAllDataSources`| 获取所有数据源列表 |
| `GET` | `/data-sources/{id}` | `getDataSourceById`| 获取指定ID的数据源 |
| `PUT` | `/data-sources/{id}` | `updateDataSource` | 更新指定ID的数据源 |
| `DELETE` | `/data-sources/{id}` | `deleteDataSource` | 删除指定ID的数据源 |
| `POST` | `/data-sources/{id}/test-connection`| `testConnection` | 测试指定数据源的连通性 |