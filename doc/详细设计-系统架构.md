### **详细设计文档 - 后端整体设计**

#### **1. 引言**

本文档是“智能数据剖析与处理平台”的后端整体设计说明，旨在为项目的初始搭建和开发提供全面的技术指导。它定义了系统的总体架构、后端技术栈、模块的划分与实现思路，以及项目代码的组织结构。

本文档是后续所有后端模块详细设计的基础和纲领。

#### **2. 系统架构**

**2.1. 架构风格**

考虑到平台轻量级、易于部署和维护的目标，我们采用\*\*“单体应用 (Monolithic Application)”\*\*架构。

  * **后端 (Backend)**: 一个独立的、可执行的Spring Boot应用程序。它将封装所有的业务逻辑、API接口、剖析器实现和数据访问层。这种方式简化了开发、测试和部署流程，非常适合作为一个自包含的工具或服务。
  * **API接口**: 后端通过一套定义清晰的RESTful API对外提供服务，可以被任何HTTP客户端（如前端SPA、脚本、或其他微服务）调用。

**2.2. 架构图**

```
+----------------------------------------------------------------------------------+
|                          后端应用 (Backend - Spring Boot)                          |
|  +----------------------------------------------------------------------------+  |
|  |                            API层 (Web & Controller)                          |  |
|  |             (处理HTTP请求, OpenAPI/Swagger UI, 参数校验)                   |  |
|  +----------------------------------------------------------------------------+  |
|                                       ^                                          |
|                                       |                                          |
|                                       V                                          |
|  +----------------------------------------------------------------------------+  |
|  |                            核心服务层 (Service)                            |  |
|  |        (ProfilingService, ReportAssemblyService, ReportService等业务逻辑)      |  |
|  +----------------------------------------------------------------------------+  |
|                                       ^                                          |
|                                       |                                          |
|                                       V                                          |
|  +----------------------------------------------------------------------------+  |
|  |                     数据访问与剖析器层 (Data & Profiler)                     |  |
|  | +----------------------+  +-----------------------------------------------+  |
|  | |     JPA/Repository   |  |        IDatabaseProfiler (接口)               |  |
|  | +----------------------+  | +--------------+  +-----------------+       |  |
|  |           |            | | MySqlProfiler|  | SqliteProfiler  | ...   |  |
|  |           V            | +--------------+  +-----------------+       |  |
|  | +----------------------+          |                 |                  |  |
|  | |   核心SQLite数据库   |          V                 V                  |  |
|  | | (配置, 任务, 报告,  |          +--------------------------------------+  |
|  | |    文件数据等)      |                                              |  |
|  | +----------------------+                                              |  |
+--|--------------------------------------------------------------------------|--+
   |                                                                          |
   +--------------------------------------------------------------------------+
                                     | (JDBC)
                                     V
                     +----------------------------------+
                     |         外部数据源 (External)      |
                     |  (MySQL, PostgreSQL, SQL Server) |
                     +----------------------------------+
```

#### **3. 主要技术栈**

| 领域 | 技术选型 | 选用理由 |
| :--- | :--- | :--- |
| **后端框架** | Spring Boot 2.7+ (Java 11/17) | 业界标准，生态成熟，开发迅速。通过依赖注入（DI）和面向切面编程（AOP）简化了复杂业务逻辑的实现。 |
| **数据访问** | Spring Data JPA + Hibernate | 简化了对核心SQLite数据库的CRUD操作，通过ORM屏蔽了大部分SQL细节，使代码更专注于业务。 |
| **核心数据库** | SQLite | 轻量级、无服务器、零配置。作为应用的内嵌数据库，用于存储所有配置、任务、报告和文件数据，使整个应用打包和迁移极为方便。 |
| **数据库驱动** | `sqlite-jdbc` | 用于Java应用连接SQLite数据库。 |
| **文件解析** | Apache POI | 强大的Java库，用于解析Microsoft Office格式文件，是处理用户上传的Excel文件的核心。 |
| **API规范与UI** | `springdoc-openapi` | **(核心)** 无缝集成OpenAPI 3和Swagger UI到Spring Boot应用中，能够基于代码注解自动生成API文档和可交互的调试页面。 |
| **构建工具** | Maven / Gradle | 标准化的项目构建和依赖管理工具。 |

#### **4. 后端模块设计与项目骨架**

推荐采用分层的项目结构，以实现高内聚、低耦合。

```
src/main/java/com/dataprofiler/
├── config/             // Spring Boot配置类 (如数据库配置, Web配置, OpenAPI配置)
├── controller/         // API Controller层: 处理HTTP请求, 负责参数校验和调用Service
│   ├── DataSourceController.java
│   ├── ProfilingTaskController.java
│   └── ReportController.java
├── service/            // 核心服务层: 实现所有业务逻辑
│   ├── impl/           // 服务的具体实现类
│   │   ├── ProfilingServiceImpl.java
│   │   └── ReportAssemblyServiceImpl.java
│   ├── DataSourceService.java
│   ├── ProfilingService.java
│   ├── ReportAssemblyService.java
│   └── StructuredReportService.java
├── profiler/           // 数据剖析器模块
│   ├── impl/           // Profiler的具体实现
│   │   ├── MySqlProfiler.java
│   │   ├── SqlServerProfiler.java
│   │   └── SqliteProfiler.java
│   └── IDatabaseProfiler.java // 统一的剖析器接口
├── repository/         // 数据访问层: 定义JPA Repository接口, 与SQLite交互
│   ├── DataSourceConfigRepository.java
│   ├── ProfilingTaskRepository.java
│   └── StructuredReportRepository.java
├── entity/             // JPA实体类: 映射到SQLite数据库中的表
│   ├── DataSourceConfig.java
│   ├── ProfilingTask.java
│   └── StructuredReport.java
└── dto/                // 数据传输对象 (Data Transfer Object)
    ├── request/        // API请求体对应的DTO
    │   └── ProfilingTaskRequest.java
    ├── response/       // API响应体对应的DTO
    │   └── ReportSummaryDto.java
    └── internal/       // 内部服务间流转的DTO
        └── RawProfileDataDto.java
```

#### **5. 核心数据持久化**

平台的所有元数据和报告数据都将持久化到一个单一的SQLite数据库文件（例如 `profiler_core.db`）中。这极大地简化了备份、恢复和迁移工作。

主要的数据表结构（简化版）：

  * **`data_sources`**: 存储用户配置的数据源信息 (`DataSourceConfig`)。
  * **`profiling_tasks`**: 存储每个剖析任务的元数据，如`taskId`, `status`, `createdAt`等。
  * **`profiling_reports`**: 存储分析完成后的报告。报告主体 (`StructuredReportDto`) 可以作为一个大的JSON文本字段进行存储。
  * **由文件导入的表**: 当用户上传Excel文件时，`FileAsTableService`会创建新的表来存储文件数据。这些表的命名将遵循一个确定的规范，如`file_[fileId]_[sheetName]`。

#### **6. API文档与调试**

为了确保API的清晰度、提升开发和测试效率，项目将内置一个交互式的API调试页面。

**6.1. 技术实现**

我们将采用 **`springdoc-openapi`** 库。它是将OpenAPI 3规范集成到现代Spring Boot应用中的首选方案。

**6.2. 集成步骤**

1.  **添加依赖**: 在项目的`pom.xml` (Maven) 或 `build.gradle` (Gradle) 文件中，添加`springdoc-openapi-ui`依赖。
    ```xml
    <dependency>
        <groupId>org.springdoc</groupId>
        <artifactId>springdoc-openapi-ui</artifactId>
        <version>1.7.0</version> </dependency>
    ```
2.  **自动配置**: 无需任何额外的Java配置。添加依赖后，Spring Boot应用在启动时会自动：
      * **生成OpenAPI规范**: 在路径 `/v3/api-docs` 下，自动生成符合OpenAPI 3规范的JSON文档。该文档是基于`@RestController`中的代码和注解动态生成的。
      * **托管Swagger UI**: 在路径 `/swagger-ui.html` 下，自动部署一个功能强大的Swagger UI页面。

**6.3. 开发工作流**

  * **代码即文档**: 开发人员在编写`@RestController`时，将使用`springdoc-openapi`提供的注解（如`@Operation`, `@Parameter`, `@ApiResponse`等）来丰富API的元数据，如接口说明、参数含义、响应码等。
  * **实时调试**: 启动后端应用后，开发人员可以直接在浏览器中访问 `http://localhost:8080/swagger-ui.html`。
  * **交互式测试**: 在Swagger UI页面上，可以看到所有API的列表。开发者可以展开任何一个API，查看其详细信息，并直接在页面上填写参数、发起请求、查看真实的响应结果。
  * **前端协同**: 前端开发者或测试人员无需自己搭建复杂的客户端，即可通过此页面了解和测试所有后端API，极大地提高了协作效率。
