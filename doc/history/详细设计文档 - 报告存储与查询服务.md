在`ReportAssemblyService`将数据精炼成最终报告后，`StructuredReportService`将接管后续的存储和查询工作。它是平台分析结果的“仓储管理员”和“数据服务员”。

-----

### **详细设计文档 - 报告仓储与查询服务 (StructuredReportService)**

#### **1. 模块概述**

**1.1. 核心职责**

`StructuredReportService`是平台数据剖析结果的持久化与服务化中心。其核心职责分为两大部分：

1.  **报告持久化 (Persistence)**:

      * 接收由`ReportAssemblyService`生成的、最终的`StructuredReportDto`对象。
      * 将这份内容丰富的报告序列化并安全地存储到核心SQLite数据库中，以供长期查询和追溯。

2.  **报告查询服务 (Retrieval)**:

      * 作为`ReportController`的后端服务，实现分层的报告查询API。
      * 根据不同的查询请求（摘要或详细），从数据库中高效地检索数据，并将其转换为API约定的格式返回。

**1.2. 核心交互**

  * **上游服务**: `ProfilingService`。在报告组装完成后，调用本服务进行存储。
  * **API层**: `ReportController`。接收到外部查询请求后，调用本服务获取数据。
  * **核心实体**: `com.dataprofiler.entity.StructuredReport`

**1.3. 主要接口**

  * **服务接口**: `com.dataprofiler.service.StructuredReportService`
  * **API入口**: `com.dataprofiler.controller.ReportController`

#### **2. 接口定义 (Java Interface)**

```java
package com.dataprofiler.service;

import com.dataprofiler.dto.request.DetailedReportRequest;
import com.dataprofiler.dto.request.ReportSummaryRequest;
import com.dataprofiler.dto.response.ReportSummaryDto;
import com.dataprofiler.dto.response.StructuredReportDto;
import org.springframework.data.domain.Page;

import java.util.List;

public interface StructuredReportService {

    /**
     * 将一份或多份组装完成的标准化报告进行持久化。
     * @param taskId 关联的剖析任务ID。
     * @param reports 需要存储的报告列表。
     */
    void saveReports(String taskId, List<StructuredReportDto> reports);

    /**
     * 根据请求获取一个或多个数据源的摘要报告。
     * 摘要报告着重于提供数据分析结果的整体概览。
     * @param request 包含目标dataSourceIds的请求对象。
     * @return 摘要报告的列表。
     */
    List<ReportSummaryDto> getReportsSummary(ReportSummaryRequest request);

    /**
     * 根据复杂的批量请求，获取详细的剖析报告。
     * 支持按数据源、Schema和表进行精确过滤，并支持分页和载荷压缩。
     * @param request 包含多个数据源、Schema和表范围的精确查询请求。
     * @param format 返回结果的载荷结构格式 ("standard" 或 "compact")。
     * @return 分页后的详细报告。
     */
    Page<StructuredReportDto> getDetailedReport(DetailedReportRequest request, String format);

}
```

#### **3. 核心流程与实现逻辑**

**3.1. 报告持久化 (`saveReports`) 逻辑**

1.  **关联任务**: 方法接收`taskId`，用于将报告与发起它的任务关联起来。
2.  **序列化**: 遍历`reports`列表。对于每一个`StructuredReportDto`对象，使用JSON库（如Jackson）将其序列化成一个JSON字符串。
3.  **实体映射与优化**:
      * 创建一个新的`StructuredReport` JPA实体对象。
      * **(关键优化)** 除了将完整的JSON字符串存入一个`@Lob`注解的TEXT字段（例如`reportJson`）外，还需要**提取出用于摘要查询和筛选的关键字段**，并将它们存入该实体独立的、**建有索引**的列中。这包括：
          * `dataSourceId`, `dataSourceName`, `dataSourceType`
          * 一个JSON字段，用于存储表和列的目录信息（即`ReportSummaryDto`所需的核心内容）。
      * 这种“预计算”或“冗余索引”的设计，是为了避免在查询摘要时，需要加载并解析庞大的`reportJson`字段，从而极大地提升摘要查询的性能。
4.  **保存**: 调用`StructuredReportRepository.save()`将实体持久化到SQLite数据库。

**3.2. 摘要查询实现 (`getReportsSummary`) 逻辑**

1.  **高效查询**: 此方法**绝不**会去读取和解析完整的`reportJson`字段。
2.  它会直接查询`StructuredReport`实体中那些被**独立存储并索引**的摘要字段（如`dataSourceName`, `dataSourceType`以及为摘要特别优化的`summaryJson`字段）。
3.  根据`ReportSummaryRequest`中的`dataSourceIds`列表，从数据库中检索出对应的记录。
4.  将这些记录直接映射或组装成`ReportSummaryDto`对象列表返回。`ReportSummaryDto`专注于概览信息，如数据源下的表列表、表的行列数量、注释、列名列表和少量样本数据，以便用户快速了解整体情况。

**3.3. 详细查询实现 (`getDetailedReport`) 逻辑**

1.  **数据检索与过滤**:
    *   根据`DetailedReportRequest`中定义的复杂结构（`datasources`字段）进行解析。
    *   构建一个动态查询，通过`dataSourceId`、`schemaName`和`tableName`从数据库中精确筛选出需要返回的报告记录。
2.  **反序列化**: 加载出每条记录的`reportJson`字段，并使用JSON库将其反序列化为`StructuredReportDto` Java对象。
3.  **分页处理**:
    *   利用数据库层面的分页能力（如Spring Data JPA的`Pageable`），根据请求中的`pagination`参数（`page`, `pageSize`）直接返回分页后的数据。这避免了在内存中加载所有数据后再进行分页，显著降低了内存消耗。
4.  **载荷结构压缩**: 在返回数据之前，检查`format`参数。
      * 如果是`compact`，则调用一个工具类或转换器，将`StructuredReportDto`中所有符合条件的数组（如`columns`和`sampleRows`），从标准的键值对格式转换为`header-rows`紧凑格式。
      * 如果是`standard`或未提供，则保持原样。
5.  **返回结果**: 将经过处理和分页的`StructuredReportDto`封装在`Page`对象中返回。

#### 4. 数据结构定义 (DTOs & JPA Entity)

本服务涉及的请求和响应数据结构如下。

##### **4.1. 请求数据结构 (Request DTOs)**

*   **摘要查询请求: `ReportSummaryRequest`**
    *   **用途**: 调用 `getReportsSummary` 接口，用于请求一个或多个数据源的摘要报告。
    *   **结构**:
        ```json
        {
          "dataSourceIds": ["ds-pg-01", "ds-mysql-01"]
        }
        ```

*   **详细报告请求: `DetailedReportRequest`**
    *   **用途**: 调用 `getDetailedReport` 接口，用于精确查询特定范围的详细报告。
    *   **结构**:
        ```json
        {
          "datasources": {
            "ds-pg-01": {
              "public": ["orders", "customers"]
            },
            "ds-mysql-01": {
              "user_db": ["users"]
            }
          },
          "pagination": {
            "page": 1,
            "pageSize": 10
          }
        }
        ```

##### **4.2. 响应数据结构 (Response DTOs)**

*   **摘要查询响应: `List<ReportSummaryDto>`**
    *   **用途**: `getReportsSummary` 接口的返回体，提供数据源的整体情况概览。
    *   **`ReportSummaryDto` 结构**:
        ```json
        {
          "dataSourceId": "ds-pg-01",
          "dataSourceName": "PostgreSQL生产库",
          "dataSourceType": "POSTGRESQL",
          "tables": [
            {
              "name": "orders",
              "schemaName": "public",
              "rowCount": 1500000,
              "columnCount": 15,
              "comment": "销售订单核心表",
              "columnNames": ["order_id", "customer_id", "order_date", "..."],
              "sampleRows": {
                "headers": ["order_id", "customer_id", "order_amount"],
                "rows": [
                  [101, "cust-abc", 150.00],
                  [102, "cust-xyz", 75.50]
                ]
              }
            }
          ]
        }
        ```

*   **详细报告响应: `Page<StructuredReportDto>`**
    *   **用途**: `getDetailedReport` 接口的返回体，提供分页后的详细报告。
    *   **`StructuredReportDto` 结构**: 这是系统的核心报告产物，其详细结构定义在《模块交互与数据定义》文档中。它包含了所有表的完整元数据、列的详细指标（如空值率、唯一值率、最大/最小值、平均值、标准差等）和样本数据。

##### **4.3. JPA 实体**

  * **`StructuredReport` (JPA Entity)**
      * 映射到SQLite的`profiling_reports`表，是报告的持久化形式。
      * **核心字段**:
          * `id` (String, PK): 报告记录的唯一ID。
          * `task` (`ProfilingTask`, ManyToOne): 与剖析任务的关联关系。
          * `dataSourceId` (String, Indexed): 数据源ID，用于快速筛选。
          * `dataSourceName` (String): 数据源名称。
          * `dataSourceType` (String): 数据源类型。
          * `summaryJson` (String/TEXT, `@Lob`): **(优化)** 存储`ReportSummaryDto`核心内容的JSON，用于快速摘要查询。
          * `reportJson` (String/TEXT, `@Lob`): 存储完整的`StructuredReportDto`序列化后的JSON字符串。

#### **5. API 端点**

由`ReportController`暴露以下RESTful API：

| Method | Path | 调用服务方法 | 描述 |
| :--- | :--- | :--- | :--- |
| `POST` | `/reports/summary` | `getReportsSummary` | 获取一个或多个数据源的摘要报告，用于快速概览。 |
| `POST` | `/reports/details` | `getDetailedReport` | 批量获取详细报告，支持按表过滤、分页和载荷压缩。 |