# DBCrawlerV3 项目数据定义文档

## 1. 文档概述

### 1.1 文档目的
本文档详细定义了DBCrawlerV3智能数据剖析与处理平台中使用的所有核心数据结构、数据格式和数据契约。这些定义确保系统各模块之间的数据交互具有一致性和准确性。

### 1.2 适用范围
- 前后端开发人员
- 系统集成人员
- API使用者
- 数据分析人员

### 1.3 数据流转概览
```
输入数据 → 原始剖析数据 → 结构化报告 → 查询响应
   ↓            ↓             ↓          ↓
Request      RawProfile    Structured   Response
  DTOs         DataDto      ReportDto     DTOs
```

## 2. 核心实体定义

### 2.1 数据源配置 (DataSourceConfig)

#### 2.1.1 实体结构
```json
{
  "id": "数据库主键ID",
  "sourceId": "数据源唯一标识符",
  "name": "数据源显示名称",
  "type": "数据源类型枚举",
  "properties": "动态属性JSON对象",
  "active": "是否激活状态",
  "createdAt": "创建时间戳",
  "updatedAt": "更新时间戳"
}
```

#### 2.1.2 数据源类型枚举
```java
public enum DataSourceType {
    MYSQL,      // MySQL数据库
    POSTGRESQL, // PostgreSQL数据库
    SQLSERVER,  // SQL Server数据库
    SQLITE,     // SQLite数据库
    ORACLE,     // Oracle数据库
    FILE        // 文件类数据源
}
```

#### 2.1.3 不同类型的Properties结构

**MySQL/PostgreSQL数据源**:
```json
{
  "host": "数据库主机地址",
  "port": "端口号",
  "database": "数据库名称",
  "username": "用户名",
  "password": "密码（加密存储）",
  "schema": "模式名称（可选）",
  "connectionTimeout": "连接超时时间（可选）",
  "queryTimeout": "查询超时时间（可选）"
}
```

**SQLite数据源**:
```json
{
  "path": "SQLite文件路径",
  "readOnly": "是否只读模式（可选）"
}
```

**文件类数据源**:
```json
{
  "originalFileName": "原始文件名",
  "internalFileId": "内部文件ID",
  "fileSize": "文件大小（字节）",
  "mimeType": "MIME类型",
  "sheetCount": "工作表数量（Excel）",
  "encoding": "文件编码（CSV）"
}
```

### 2.2 剖析任务 (ProfilingTask)

#### 2.2.1 实体结构
```json
{
  "id": "数据库主键ID",
  "taskId": "任务唯一标识符",
  "name": "任务名称",
  "description": "任务描述",
  "status": "任务状态枚举",
  "info": "执行信息和日志",
  "totalDataSources": "总数据源数量",
  "processedDataSources": "已处理数据源数量",
  "createdAt": "创建时间",
  "startedAt": "开始时间",
  "completedAt": "完成时间"
}
```

#### 2.2.2 任务状态枚举
```java
public enum TaskStatus {
    PENDING,    // 等待执行
    RUNNING,    // 正在执行
    COMPLETED,  // 执行完成
    FAILED,     // 执行失败
    CANCELLED,  // 已取消
    TIMEOUT     // 执行超时
}
```

### 2.3 文件元数据 (FileMetadata)

#### 2.3.1 实体结构
```json
{
  "id": "数据库主键ID",
  "filename": "当前文件名",
  "originalFilename": "原始文件名",
  "filePath": "文件存储路径",
  "fileSize": "文件大小",
  "mimeType": "MIME类型",
  "uploadedAt": "上传时间",
  "convertedAt": "转换时间",
  "converted": "是否已转换",
  "conversionError": "转换错误信息",
  "tableCount": "表数量",
  "dataSourceId": "关联数据源ID",
  "description": "文件描述"
}
```

## 3. 数据传输对象 (DTOs)

### 3.1 请求数据结构

#### 3.1.1 剖析任务请求 (ProfilingTaskRequest)
```json
{
  "name": "任务名称",
  "description": "任务描述（可选）",
  "dataSourceIds": [
    "数据源ID列表"
  ],
  "scope": {
    "数据源ID": {
      "schemas": ["模式名称列表"],
      "tables": ["表名列表（可选）"]
    }
  },
  "options": {
    "samplingRate": "采样率（0.0-1.0）",
    "maxSampleSize": "最大采样数量",
    "includeSystemTables": "是否包含系统表",
    "calculateStatistics": "是否计算统计信息"
  }
}
```

#### 3.1.2 摘要报告请求 (ReportSummaryRequest)
```json
{
  "dataSourceIds": [
    "数据源ID列表"
  ],
  "taskIds": [
    "任务ID列表（可选）"
  ]
}
```

#### 3.1.3 详细报告请求 (DetailedReportRequest)
```json
{
  "datasources": {
    "数据源ID": {
      "模式名": ["表名列表"]
    }
  },
  "pagination": {
    "page": "页码（从1开始）",
    "pageSize": "每页大小"
  },
  "format": "响应格式（standard/compact）"
}
```

### 3.2 响应数据结构

#### 3.2.1 任务状态响应 (TaskStatusResponse)
```json
{
  "taskId": "任务ID",
  "status": "任务状态",
  "name": "任务名称",
  "description": "任务描述",
  "progress": {
    "total": "总数据源数量",
    "processed": "已处理数量",
    "percentage": "完成百分比"
  },
  "timing": {
    "createdAt": "创建时间",
    "startedAt": "开始时间",
    "completedAt": "完成时间",
    "duration": "执行时长（秒）"
  },
  "info": "执行信息",
  "error": "错误信息（如果有）"
}
```

#### 3.2.2 摘要报告响应 (ReportSummaryDto)
```json
[
  {
    "dataSourceId": "数据源ID",
    "dataSourceName": "数据源名称",
    "dataSourceType": "数据源类型",
    "schemas": [
      {
        "schemaName": "模式名称",
        "tableCount": "表数量",
        "totalRows": "总行数",
        "tables": [
          {
            "tableName": "表名",
            "rowCount": "行数",
            "columnCount": "列数",
            "comment": "表注释",
            "lastAnalyzed": "最后分析时间"
          }
        ]
      }
    ],
    "statistics": {
      "totalTables": "总表数",
      "totalColumns": "总列数",
      "totalRows": "总行数",
      "averageRowsPerTable": "平均每表行数",
      "largestTable": "最大表信息"
    }
  }
]
```

## 4. 核心数据流转格式

### 4.1 原始剖析数据 (RawProfileDataDto)

#### 4.1.1 整体结构
```json
{
  "dataSourceId": "数据源ID",
  "dataSourceType": "数据源类型",
  "databaseName": "数据库名称",
  "schemaName": "模式名称",
  "profilingTimestamp": "剖析时间戳",
  "profilingMode": "剖析模式（EXACT/APPROXIMATE）",
  "samplingInfo": {
    "samplingRate": "采样率",
    "sampleSize": "采样数量",
    "totalRows": "总行数估算"
  },
  "tables": [
    "表剖析数据列表"
  ]
}
```

#### 4.1.2 表剖析数据结构
```json
{
  "tableName": "表名",
  "schemaName": "模式名",
  "tableType": "表类型（TABLE/VIEW/SYSTEM_TABLE）",
  "rowCount": "精确行数",
  "approximateRowCount": "近似行数",
  "tableSize": "表大小（字节）",
  "comment": "表注释",
  "createdAt": "创建时间",
  "lastModified": "最后修改时间",
  "columns": [
    "列剖析数据列表"
  ],
  "indexes": [
    "索引信息列表"
  ],
  "constraints": [
    "约束信息列表"
  ]
}
```

#### 4.1.3 列剖析数据结构
```json
{
  "columnName": "列名",
  "dataType": "标准数据类型",
  "nativeType": "原生数据类型",
  "columnSize": "列大小",
  "decimalDigits": "小数位数",
  "nullable": "是否可空",
  "defaultValue": "默认值",
  "comment": "列注释",
  "ordinalPosition": "列位置",
  "constraints": {
    "isPrimaryKey": "是否主键",
    "isForeignKey": "是否外键",
    "isUnique": "是否唯一",
    "isIndexed": "是否有索引"
  },
  "statistics": {
    "nullCount": "空值数量",
    "nullRate": "空值率",
    "uniqueCount": "唯一值数量",
    "uniqueRate": "唯一值率",
    "minValue": "最小值",
    "maxValue": "最大值",
    "avgValue": "平均值（数值类型）",
    "stdDev": "标准差（数值类型）",
    "minLength": "最小长度（字符类型）",
    "maxLength": "最大长度（字符类型）",
    "avgLength": "平均长度（字符类型）"
  },
  "sampleValues": [
    "样本值列表"
  ],
  "valueDistribution": {
    "topValues": [
      {
        "value": "值",
        "count": "出现次数",
        "percentage": "占比"
      }
    ],
    "histogram": [
      {
        "range": "值范围",
        "count": "数量",
        "percentage": "占比"
      }
    ]
  }
}
```

### 4.2 结构化报告数据 (StructuredReportDto)

#### 4.2.1 整体结构
```json
{
  "taskId": "任务ID",
  "dataSourceId": "数据源ID",
  "dataSourceName": "数据源名称",
  "dataSourceType": "数据源类型",
  "generatedAt": "生成时间",
  "database": {
    "name": "数据库名称",
    "version": "数据库版本",
    "charset": "字符集",
    "collation": "排序规则"
  },
  "schemas": [
    "模式报告列表"
  ],
  "summary": {
    "totalTables": "总表数",
    "totalColumns": "总列数",
    "totalRows": "总行数",
    "dataQualityScore": "数据质量评分",
    "completenessScore": "完整性评分",
    "consistencyScore": "一致性评分"
  }
}
```

#### 4.2.2 模式报告结构
```json
{
  "schemaName": "模式名称",
  "tables": [
    "表报告列表"
  ],
  "statistics": {
    "tableCount": "表数量",
    "totalRows": "总行数",
    "averageRowsPerTable": "平均每表行数",
    "largestTable": "最大表名",
    "smallestTable": "最小表名"
  }
}
```

#### 4.2.3 表报告结构
```json
{
  "name": "表名",
  "schemaName": "模式名",
  "rowCount": "行数",
  "columnCount": "列数",
  "comment": "表注释",
  "tableType": "表类型",
  "columns": [
    "列报告列表"
  ],
  "sampleRows": {
    "headers": ["列名列表"],
    "rows": [
      ["样本数据行"]
    ]
  },
  "dataQuality": {
    "completeness": "完整性评分",
    "consistency": "一致性评分",
    "accuracy": "准确性评分",
    "issues": [
      {
        "type": "问题类型",
        "description": "问题描述",
        "severity": "严重程度",
        "affectedColumns": ["受影响列"]
      }
    ]
  },
  "relationships": {
    "primaryKeys": ["主键列"],
    "foreignKeys": [
      {
        "column": "外键列",
        "referencedTable": "引用表",
        "referencedColumn": "引用列"
      }
    ],
    "indexes": [
      {
        "name": "索引名",
        "columns": ["索引列"],
        "unique": "是否唯一",
        "type": "索引类型"
      }
    ]
  }
}
```

#### 4.2.4 列报告结构
```json
{
  "name": "列名",
  "type": "数据类型",
  "nullable": "是否可空",
  "isPrimaryKey": "是否主键",
  "isForeignKey": "是否外键",
  "comment": "列注释",
  "metrics": {
    "nullCount": "空值数量",
    "nullRate": "空值率",
    "distinctCount": "唯一值数量",
    "distinctRate": "唯一值率",
    "range": {
      "min": "最小值",
      "max": "最大值"
    },
    "statistics": {
      "mean": "平均值",
      "median": "中位数",
      "mode": "众数",
      "stddev": "标准差",
      "variance": "方差",
      "skewness": "偏度",
      "kurtosis": "峰度"
    },
    "length": {
      "min": "最小长度",
      "max": "最大长度",
      "avg": "平均长度"
    }
  },
  "patterns": {
    "commonPatterns": [
      {
        "pattern": "模式",
        "count": "匹配数量",
        "percentage": "占比"
      }
    ],
    "dataFormat": "数据格式（如日期格式、邮箱格式等）"
  },
  "sampleValues": ["样本值列表"]
}
```

## 5. 载荷格式定义

### 5.1 标准格式 (Standard Format)
标准格式使用完整的JSON对象结构，适合详细的数据分析和展示。

### 5.2 紧凑格式 (Compact Format)
紧凑格式使用header-rows结构，减少数据传输量，适合AI应用和大数据量场景。

#### 5.2.1 紧凑格式示例
```json
{
  "sampleRows": {
    "headers": ["order_id", "customer_id", "order_amount", "order_date"],
    "rows": [
      [101, "cust-abc", 150.00, "2023-10-27"],
      [102, "cust-xyz", 75.50, "2023-10-27"],
      [103, "cust-def", 200.25, "2023-10-28"]
    ]
  },
  "columns": {
    "headers": ["name", "type", "nullable", "metrics"],
    "rows": [
      ["order_id", "INTEGER", false, {"nullCount": 0, "uniqueCount": 1500000}],
      ["customer_id", "VARCHAR(50)", false, {"nullCount": 0, "uniqueCount": 125000}],
      ["order_amount", "DECIMAL(10,2)", false, {"nullCount": 50, "avg": 125.75}],
      ["order_date", "DATE", false, {"nullCount": 0, "uniqueCount": 365}]
    ]
  }
}
```

## 6. 数据质量评估指标

### 6.1 完整性指标 (Completeness Metrics)
```json
{
  "completeness": {
    "overallScore": "总体完整性评分（0-100）",
    "columnCompleteness": {
      "列名": {
        "score": "列完整性评分",
        "nullRate": "空值率",
        "missingPatterns": ["缺失模式"]
      }
    },
    "rowCompleteness": {
      "completeRows": "完整行数",
      "incompleteRows": "不完整行数",
      "completenessRate": "行完整率"
    }
  }
}
```

### 6.2 一致性指标 (Consistency Metrics)
```json
{
  "consistency": {
    "overallScore": "总体一致性评分（0-100）",
    "dataTypeConsistency": {
      "score": "数据类型一致性评分",
      "violations": ["违规记录"]
    },
    "formatConsistency": {
      "score": "格式一致性评分",
      "patterns": {
        "列名": {
          "dominantPattern": "主要模式",
          "patternCoverage": "模式覆盖率",
          "violations": ["违规值"]
        }
      }
    },
    "referentialIntegrity": {
      "score": "引用完整性评分",
      "violations": [
        {
          "foreignKey": "外键",
          "violationCount": "违规数量",
          "violationRate": "违规率"
        }
      ]
    }
  }
}
```

### 6.3 准确性指标 (Accuracy Metrics)
```json
{
  "accuracy": {
    "overallScore": "总体准确性评分（0-100）",
    "domainValidation": {
      "列名": {
        "validValues": "有效值数量",
        "invalidValues": "无效值数量",
        "validationRules": ["验证规则"],
        "violations": ["违规值"]
      }
    },
    "rangeValidation": {
      "列名": {
        "expectedRange": "期望范围",
        "actualRange": "实际范围",
        "outOfRangeCount": "超范围数量"
      }
    }
  }
}
```

## 7. 错误和异常数据结构

### 7.1 标准错误响应
```json
{
  "error": {
    "code": "错误代码",
    "message": "错误消息",
    "details": "详细错误信息",
    "timestamp": "错误时间戳",
    "path": "请求路径",
    "traceId": "追踪ID"
  }
}
```

### 7.2 业务异常响应
```json
{
  "error": {
    "code": "PROFILING_FAILED",
    "message": "数据剖析执行失败",
    "details": {
      "taskId": "任务ID",
      "dataSourceId": "数据源ID",
      "failureReason": "失败原因",
      "sqlError": "SQL错误信息",
      "suggestions": ["解决建议"]
    }
  }
}
```

### 7.3 验证错误响应
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "请求参数验证失败",
    "details": {
      "fieldErrors": [
        {
          "field": "字段名",
          "rejectedValue": "被拒绝的值",
          "message": "错误消息"
        }
      ]
    }
  }
}
```

## 8. 配置和元数据

### 8.1 系统配置数据
```json
{
  "profilingConfig": {
    "defaultSamplingRate": "默认采样率",
    "maxSampleSize": "最大采样数量",
    "queryTimeout": "查询超时时间",
    "approximateThreshold": "近似查询阈值",
    "maxConcurrentTasks": "最大并发任务数"
  },
  "databaseDialects": {
    "MYSQL": {
      "driverClass": "驱动类名",
      "urlTemplate": "URL模板",
      "features": ["支持特性"]
    }
  }
}
```

### 8.2 数据类型映射
```json
{
  "typeMapping": {
    "MYSQL": {
      "INT": "INTEGER",
      "VARCHAR": "STRING",
      "DECIMAL": "NUMERIC",
      "DATETIME": "TIMESTAMP"
    },
    "POSTGRESQL": {
      "INTEGER": "INTEGER",
      "TEXT": "STRING",
      "NUMERIC": "NUMERIC",
      "TIMESTAMP": "TIMESTAMP"
    }
  }
}
```

## 9. 版本控制和兼容性

### 9.1 API版本信息
```json
{
  "apiVersion": "v1.0",
  "dataFormatVersion": "1.0",
  "compatibilityMatrix": {
    "v1.0": {
      "supportedFormats": ["standard", "compact"],
      "deprecatedFields": [],
      "newFields": []
    }
  }
}
```

### 9.2 数据格式演进
- 新增字段：向后兼容，可选字段
- 字段重命名：保留旧字段名作为别名
- 字段删除：标记为废弃，逐步移除
- 类型变更：提供转换函数

## 10. 性能优化数据结构

### 10.1 分页数据结构
```json
{
  "content": ["数据内容"],
  "pagination": {
    "page": "当前页码",
    "pageSize": "每页大小",
    "totalElements": "总元素数",
    "totalPages": "总页数",
    "hasNext": "是否有下一页",
    "hasPrevious": "是否有上一页"
  }
}
```

### 10.2 缓存键结构
```json
{
  "cacheKey": {
    "type": "缓存类型",
    "dataSourceId": "数据源ID",
    "schemaName": "模式名",
    "tableName": "表名",
    "version": "版本号",
    "hash": "内容哈希"
  }
}
```

---

**文档版本**: v1.0  
**最后更新**: 2025年1月  
**维护者**: DBCrawlerV3开发团队  
**相关文档**: 项目整体设计文档、API设计文档、数据库设计文档