### **详细设计文档 - 文件即服务 (FileAsTableService)**

#### **1. 模块概述**

**1.1. 核心职责**

`FileAsTableService` 的核心职责是将用户上传的文件类数据（目前主要为Excel）加载并持久化到平台的核心SQLite数据库中。它通过将**每个Excel文件中的Sheet映射为SQLite中的一张表**，从而将非结构化的文件数据“数据库化”，使其能够被后续标准的、基于JDBC的`ProfilingService`无缝处理。

该服务是平台处理异构数据源能力的关键一环，是典型的**适配器模式**应用。

**1.2. 核心交互**

  * **触发**: `FileController`在接收到文件上传请求后，会先创建一个`type: FILE`的`DataSourceConfig`实体，然后调用本服务。
  * **输入**: `DataSourceConfig`对象（包含了文件的元数据和唯一ID）和文件的数据流。
  * **输出**: 一个`FileLoadResult`对象，其中包含了成功加载的Sheet信息及其在数据库中对应的表名和行数。

**1.3. 主要接口与API**

  * **服务接口**: `com.dataprofiler.service.FileAsTableService`
  * **API入口**: `com.dataprofiler.controller.FileController`

#### **2. 接口定义 (Java Interface)**

```java
package com.dataprofiler.service;

import com.dataprofiler.dto.FileLoadResult;
import com.dataprofiler.entity.DataSourceConfig;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;

public interface FileAsTableService {

    /**
     * 处理上传的Excel文件，将其内容解析并加载到核心SQLite数据库中。
     * @param file 上传的文件对象。
     * @param dataSourceName 用户为该文件数据源指定的名称。
     * @return 包含加载结果信息的DTO，如生成的dataSourceId和每个Sheet对应的表信息。
     * @throws IOException 文件读取或解析异常。
     */
    FileLoadResult loadExcelFileToDatabase(MultipartFile file, String dataSourceName) throws IOException;

}
```

#### **3. 核心流程与实现逻辑**

`loadExcelFileToDatabase`方法的内部执行逻辑如下：

1.  **文件校验 (Validation)**:

      * 检查`file`对象是否为空，文件大小是否超限。
      * 校验文件的`ContentType`或文件名后缀，确保是支持的Excel格式（如`.xlsx`, `.xls`）。

2.  **创建数据源记录 (Create DataSource Entry)**:

      * 在处理文件内容之前，首先为这个上传的文件创建一个`DataSourceConfig`记录。
      * 调用`DataSourceService.createDataSource()`，传入一个`type`为`FILE`的对象，并包含文件名、大小、MIME类型等元数据。
      * 此操作会生成一个唯一的`dataSourceId`，这个ID将作为后续生成表名的重要前缀。

3.  **解析Excel文件 (Parse Excel File)**:

      * 使用**Apache POI**库的`WorkbookFactory.create(file.getInputStream())`来打开Excel工作簿。此方法能自动兼容`HSSF` (.xls) 和`XSSF` (.xlsx) 两种格式。

4.  **遍历Sheet并创建表 (Iterate Sheets & Create Tables)**:

      * 使用`for-each`循环遍历`Workbook`中的每一个`Sheet`。
      * **对于每个Sheet**:
        a. **生成表名 (Generate Table Name)**:
        \* 获取Sheet的名称（如 "Q1-Sales"）。
        \* 对Sheet名进行**SQL安全净化 (Sanitize)**，移除空格、特殊字符，例如转换为 "Q1\_Sales"。
        \* 将净化后的Sheet名与上一步生成的`dataSourceId`组合，形成一个全局唯一的表名，例如: `file_ds-xyz-789_Q1_Sales`。这可以有效避免不同文件或Sheet之间的命名冲突。
        b. **推断列定义 (Infer Column Definitions)**:
        \* 读取Sheet的**第一行**作为表头。每个单元格的值将作为列名（同样需要进行SQL安全净化）。
        \* **类型推断 (Type Inference)** (可选但推荐): 检查每个列的前N行（如100行）数据，以推断该列最合适的数据类型（`INTEGER`, `REAL`, `TEXT`）。`TEXT`是所有情况下的安全默认选项。
        c. **执行DDL**: 动态构建`CREATE TABLE` SQL语句，并通过JDBC在核心SQLite数据库中创建这张表。

5.  **批量加载数据 (Batch Load Data)**:

      * 从Sheet的第二行开始，遍历所有数据行。
      * 使用**JDBC Batch Updates**来提升性能。将`INSERT`语句添加到批处理中（`PreparedStatement.addBatch()`），每累计到一定数量（如1000条）或遍历完成后，执行一次`executeBatch()`。这远比逐条插入高效。

6.  **资源清理 (Resource Cleanup)**:

      * 在`try-with-resources`块中处理文件流和`Workbook`对象，确保它们在处理完毕或发生异常时都能被正确关闭。

7.  **返回结果 (Return Result)**:

      * 在所有Sheet都成功加载后，构建并返回`FileLoadResult`对象，其中包含了本次操作的摘要信息。

#### **4. 数据结构定义 (DTOs)**

  * **`FileLoadResult` (DTO)**

      * 成功处理文件上传后，返回给API调用者的结果对象。
      * **结构定义**:
        ```java
        public class FileLoadResult {
            private String dataSourceId; // 为此文件生成的DataSource唯一ID
            private String originalFileName; // 上传的原始文件名
            private long fileSize; // 文件大小（字节）
            private List<LoadedTableInfo> loadedTables; // 成功加载的Sheet信息列表

            // Constructors, Getters, Setters
        }
        ```

  * **`LoadedTableInfo` (sub-DTO)**

      * `FileLoadResult`的内嵌对象，描述了单个Sheet的加载情况。
      * **结构定义**:
        ```java
        public class LoadedTableInfo {
            private String sheetName; // Excel中的原始Sheet名称
            private String tableName; // 在SQLite中生成的对应表名
            private long rowCount; // 从该Sheet加载的数据行数
            private List<String> columns; // 从表头解析出的列名列表

            // Constructors, Getters, Setters
        }
        ```

#### **5. API 端点**

由`FileController`暴露以下RESTful API：

| Method | Path | Request `Content-Type` | 描述 |
| :--- | :--- | :--- | :--- |
| `POST` | `/files/upload` | `multipart/form-data` | 上传Excel文件进行处理和加载。请求体包含一个名为`file`的文件部分和一个名为`dataSourceName`的文本部分。 |